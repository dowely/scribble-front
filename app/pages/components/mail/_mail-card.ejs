<% let users = require('../db/users.json') %>

<!-- parsing send time -->

<%
  let now = new Date('2022-02-22T18:37:12.324Z')
  let sendTime
  let topRightTime

  if(mail.sendTime === '') {

    topRightTime = ''

  } else {

    sendTime = new Date(mail.sendTime)

    if(sameDate(now, sendTime) && sameHour(now, sendTime)) {
      topRightTime = `${now.getMinutes() - sendTime.getMinutes()} min`
    } else if(sameDate(now, sendTime)) {
      topRightTime = sendTime.getUTCHours() <= 12 ? `${sendTime.getUTCHours()}:${sendTime.getMinutes()} AM` : `${sendTime.getUTCHours() - 12}:${sendTime.getMinutes()} PM`
    } else {
      topRightTime = `${sendTime.getMonth() + 1}/${sendTime.getDate()}/${sendTime.getFullYear().toString().substr(-2)}`
    }
  }

  function sameDate(d1, d2) {
    return d1.getFullYear() === d2.getFullYear() &&
    d1.getMonth() === d2.getMonth() &&
    d1.getDate() === d2.getDate()
  }

  function sameHour(d1, d2) {
    return sameDate(d1, d2) && 
    d1.getUTCHours() === d2.getUTCHours()
  }
%>

<!-- checking if already read -->

<%
  let wasRead = mail.readBy.filter(user => user == 'John Schaffer').length > 0
%>

<!-- checking if incoming -->

<%
  mail.incoming = mail.from !== 'John Schaffer'
%>

<!-- getting user objects -->

<%

  let sender = users.filter(user => user.name == mail.from)[0]

  let recipients = users.filter(user => mail.to.find(name => name == user.name))

%>

<div class="mail-card <%= wasRead ? 'mail-card--read' : ''%>">
  <div class="mail-card__wrapper">

    <div class="mail-card__avatar-container">

      <% if(mail.incoming) {

        if(sender.avatar == '') { %>

          <h4 class="mail-card__initials"><%= sender.initials %></h4>

        <% } else { %>

          <img src="<%= sender.avatar %>" alt="A photo of <%= sender.name %>" class="mail-card__avatar">

        <% }
      } else {

        if(recipients.length == 0) { %>

          <h4 class="mail-card__initials">O</h4>

        <% } else if(recipients[0].avatar == '') { %>

          <h4 class="mail-card__initials"><%= recipients[0].initials %></h4>

        <% } else { %>

          <img src="<%= recipients[0].avatar %>" alt="A photo of <%= recipients[0].name %>" class="mail-card__avatar">

        <% }
      } %>

    </div>

    <div class="mail-card__user-cointainer">
      <h4 class="mail-card__user"><%= mail.from %></h4>
    </div>

    <div class="mail-card__subject-container">
      <h5 class="mail-card__subject"><%= mail.subject == '' ? '(No subject)' : mail.subject %></h5>
    </div>

    <span class="mail-card__top-right mail-card__top-right--time"><%= topRightTime %></span>

    <p class="mail-card__body"><%= mail.body %></p>

  </div>
</div>